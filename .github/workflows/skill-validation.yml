name: Skill Validation

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  contents: read

jobs:
  # Prepare matrix for parallel evaluation (default)
  prepare:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/test')
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
      filter: ${{ steps.parse.outputs.filter }}
    
    steps:
      - name: Parse test command
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          FILTER="all"
          
          if echo "$COMMENT" | grep -q "/test copilot"; then
            FILTER="copilot"
          elif echo "$COMMENT" | grep -q "/test ollama"; then
            FILTER="ollama"
          elif echo "$COMMENT" | grep -q "/test gemini"; then
            FILTER="gemini"
          fi
          
          echo "filter=$FILTER" >> $GITHUB_OUTPUT
      
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate matrix
        id: generate-matrix
        run: |
          python3 -m pip install -q pyyaml
          MATRIX=$(python3 ci/matrix_generator.py --filter-provider "${{ steps.parse.outputs.filter }}")
          echo "matrix<<EOF" >> $GITHUB_OUTPUT
          echo "$MATRIX" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

  # Run evaluations in parallel (default: matrix strategy)
  evaluate:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Copilot CLI
        if: matrix.provider == 'copilot'
        run: npm install -g @github/copilot

      - uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Detect changes
        id: changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python3 ci/detect_changes.py ${{ github.event.issue.number }} > modified_skills.txt 2>/dev/null || echo "" > modified_skills.txt
          SKILLS=$(cat modified_skills.txt)
          echo "skills=$SKILLS" >> $GITHUB_OUTPUT

      - name: Run evaluation for ${{ matrix.display_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COPILOT_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
          MODIFIED_SKILLS: ${{ steps.changes.outputs.skills }}
        run: |
          python3 ci/run_evaluation.py "${{ matrix.provider }}" "${{ matrix.model }}" 50 "${{ matrix.extra_args }}"

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.provider }}-${{ matrix.model }}
          path: tests/results/${{ matrix.provider }}/${{ matrix.model }}/
          retention-days: 1

  # Consolidate results from all parallel runs
  consolidate:
    needs: evaluate
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: tests/results/

      - name: Consolidate results
        run: python3 ci/consolidate_results.py || true

      - name: Post results
        uses: marocchino/sticky-pull-request-comment@v2
        if: hashFiles('comment.md') != ''
        with:
          number: ${{ github.event.issue.number }}
          path: comment.md
