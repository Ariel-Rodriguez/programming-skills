name: Skill Validation

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  contents: read

jobs:
  # Job 1: Generate matrix from config
  prepare:
    runs-on: ubuntu-latest
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/test') && github.actor == 'Ariel-Rodriguez'
    outputs:
      matrix: ${{ steps.generate-matrix.outputs.matrix }}
      filter: ${{ steps.parse.outputs.filter }}
      use-parallel: ${{ steps.parse.outputs.use-parallel }}
    
    steps:
      - name: Parse test command
        id: parse
        run: |
          COMMENT="${{ github.event.comment.body }}"
          FILTER="all"
          USE_PARALLEL="false"
          
          # Check for specific provider filter
          if echo "$COMMENT" | grep -q "/test copilot"; then
            FILTER="copilot"
          elif echo "$COMMENT" | grep -q "/test ollama"; then
            FILTER="ollama"
          elif echo "$COMMENT" | grep -q "/test gemini"; then
            FILTER="gemini"
          elif echo "$COMMENT" | grep -q "/test all"; then
            FILTER="all"
          fi
          
          # Check for parallel flag
          if echo "$COMMENT" | grep -q "parallel"; then
            USE_PARALLEL="true"
          fi
          
          echo "filter=$FILTER" >> $GITHUB_OUTPUT
          echo "use-parallel=$USE_PARALLEL" >> $GITHUB_OUTPUT
          echo "Testing with filter: $FILTER (parallel: $USE_PARALLEL)"
      
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Generate matrix
        id: generate-matrix
        run: |
          MATRIX=$(python3 ci/matrix_generator.py --filter-provider "${{ steps.parse.outputs.filter }}")
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "Generated matrix:"
          echo "$MATRIX" | jq .

  # Job 2: Run evaluations (parallel or sequential based on parse)
  evaluate:
    needs: prepare
    runs-on: ubuntu-latest
    if: needs.prepare.outputs.use-parallel == 'false'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Copilot CLI
        run: npm install -g @github/copilot

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.11

      - name: Run orchestration
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COPILOT_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
        run: |
          chmod +x ci/*.sh
          ./ci/orchestrate_evaluations.sh ${{ github.event.issue.number }} --filter-provider "${{ needs.prepare.outputs.filter }}"

      - name: Post results
        uses: marocchino/sticky-pull-request-comment@v2
        if: always() && hashFiles('comment.md') != ''
        with:
          number: ${{ github.event.issue.number }}
          path: comment.md

  # Job 3: Run evaluations in parallel (matrix strategy)
  evaluate-parallel:
    needs: prepare
    runs-on: ubuntu-latest
    if: needs.prepare.outputs.use-parallel == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Copilot CLI
        if: matrix.provider == 'copilot'
        run: npm install -g @github/copilot

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.11

      - name: Detect changes
        id: changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x ci/detect_changes.sh
          MODIFIED_SKILLS=$(./ci/detect_changes.sh ${{ github.event.issue.number }})
          echo "modified_skills=$MODIFIED_SKILLS" >> $GITHUB_OUTPUT

      - name: Run evaluation for ${{ matrix.display_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COPILOT_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OLLAMA_API_KEY: ${{ secrets.OLLAMA_API_KEY }}
          MODIFIED_SKILLS: ${{ steps.changes.outputs.modified_skills }}
        run: |
          chmod +x ci/run_evaluation.sh
          ./ci/run_evaluation.sh "${{ matrix.provider }}" "${{ matrix.model }}" 50 "${{ matrix.extra_args }}"

      - name: Upload results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: results-${{ matrix.provider }}-${{ matrix.model }}
          path: tests/results/${{ matrix.provider }}/${{ matrix.model }}/

  # Job 4: Consolidate parallel results
  consolidate:
    needs: [prepare, evaluate-parallel]
    runs-on: ubuntu-latest
    if: needs.prepare.outputs.use-parallel == 'true' && always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: tests/results/

      - name: Consolidate results
        run: |
          chmod +x ci/consolidate_results.sh
          ./ci/consolidate_results.sh || true

      - name: Post consolidated results
        uses: marocchino/sticky-pull-request-comment@v2
        if: hashFiles('comment.md') != ''
        with:
          number: ${{ github.event.issue.number }}
          path: comment.md
